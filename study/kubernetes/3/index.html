<!DOCTYPE html>
<html lang="kr-ko">
    <head>
        <meta name="description" content="" />

<meta name="og:type" content="website" />
<meta property="og:title" content="kube 3" />
<meta property="og:site_name" content="kube 3" />
<meta property="og:description" content="" />
<meta property="og:url" content="https://wacilpong.github.io/blog/study/kubernetes/3/" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="kube 3" />
<meta name="twitter:description" content="" />

<meta property="og:image" content="https://ca.slack-edge.com/T17RWEQDQ-UHVBKS9HA-41689aac3b87-512" />
<meta
  property="twitter:image:src"
  content="https://ca.slack-edge.com/T17RWEQDQ-UHVBKS9HA-41689aac3b87-512"
/>


<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-171393148-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "UA-171393148-1");
</script>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>kube 3</title>
        
            <link rel="icon" href="https://wacilpong.github.io/blog/favicon.ico">
        
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #469160;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="https://wacilpong.github.io/blog/css/main.css">


 <link rel="stylesheet" href="https://wacilpong.github.io/blog/css/custom.css"> 


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script>






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.73.0" />
        

        

        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">kube 3</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/blog/">Home</a></li>
                            
                                <li><a href="/blog/tags/">Category</a></li>
                            
                                <li><a href="/blog/post/">Posts</a></li>
                            
                                <li><a href="/blog/study/">Study</a></li>
                            
                                <li><a href="/blog/learned/">What I Learned</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/wacilpong/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/areum-han-a10645118/"><i class="fa fa-linkedin"></i></a></li>
                            
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2>kube 3</h2>
        <h5>ingress</h5>
        
<a href="https://wacilpong.github.io/blog/tags/cloud-computing"><kbd class="item-tag">cloud-computing</kbd></a>


    </div>

    <div align="start" class="content"><h3 id="인그레스ingress-오브젝트의-기본-기능">인그레스(Ingress) 오브젝트의 기본 기능</h3>
<ul>
<li><code>외부 요청의 라우팅</code>: 특정 경로로 들어온 요청을 어떤 서비스로 전달할지 정의하는 라우팅 규칙 설정 가능</li>
<li><code>가상 호스트 기반의 요청 처리</code>: 같은 IP에 대해 다른 도메인 이름으로 요청이 오면, 어떻게 처리할 것인지 정의 가능</li>
<li><code>SSL/TLS 보안 연결 처리</code>: 여러 서비스로 요청을 라우팅할 때, 인증서를 쉽게 적용할 수 있음</li>
</ul>
<p><br /></p>
<h3 id="사용하는-이유">사용하는 이유</h3>
<ul>
<li>3개의 디플로이먼트를 외부에 노출해야 한다면?</li>
<li>NodePort, LoadBalancer 타입 서비스 3개를 생성하는 방법이 있다.</li>
<li>위 방식은 서비스마다 디플로이먼트에 일일이 설정을 해야만 한다.</li>
<li>이때 인그레스를 사용하면 URL 엔드포인트를 하나만 생성하면 된다.</li>
<li>따라서 클라이언트는 인그레스의 URL로만 접근하고, 그 요청은 적절히 처리되어 디플로이먼트의 파드로 전달된다.</li>
<li>외부 요청에 대한 처리 규칙을 쿠버네티스 기능으로 관리할 수 있는 것이 핵심이다.</li>
</ul>
<p><br /></p>
<h3 id="예제">예제</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: networking.k8s.io/v1
<span style="color:#66d9ef">kind</span>: Ingress
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: ingress-example
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">nginx.ingress.kubernetes.io/rewrite-target</span>: /
    <span style="color:#66d9ef">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;nginx&#34;</span>
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">rules</span>:
    - <span style="color:#66d9ef">host</span>: alicek106.example.com <span style="color:#75715e"># [1]</span>
      <span style="color:#66d9ef">http</span>:
        <span style="color:#66d9ef">paths</span>:
          - <span style="color:#66d9ef">path</span>: /echo-hostname <span style="color:#75715e"># [2]</span>
            <span style="color:#66d9ef">pathType</span>: Prefix
            <span style="color:#66d9ef">backend</span>:
              <span style="color:#66d9ef">service</span>:
                <span style="color:#66d9ef">name</span>: hostname-service <span style="color:#75715e"># [3]</span>
                <span style="color:#66d9ef">port</span>:
                  <span style="color:#66d9ef">number</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl apply -f ingress-example.yaml
$ kubectl get ing
</code></pre></div><ul>
<li>인그레스를 정의하는 YAML 파일 중에서 annotation 항목을 통해 인그레스의 추가 기능을 사용할 수 있다.</li>
<li>host: 해당 도메인 이름으로 접근하는 요청에 대해서 처리 규칙을 적용한다.</li>
<li>path: 해당 경로에 들어온 요청을 어느 서비스로 전달할 것인지 정의한다.</li>
<li>name, port: path로 들어온 요청이 전달될 서비스와 포트이다.</li>
<li><strong>인그레스는 요청을 처리하는 규칙을 정의하는 오브젝트일 뿐이므로, 인그레스 컨트롤러라는 특수한 서버가 필요하다.</strong></li>
</ul>
<h3 id="인그레스-컨트롤러-ingress-controller">인그레스 컨트롤러 (ingress controller)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.2.0/deploy/static/provider/aws/deploy.yaml

<span style="color:#75715e"># ingress-nginx 네임스페이스의 디플로이먼트와 파드를</span>
<span style="color:#75715e"># 확인해보면 nginx 웹서버가 생성됨</span>
$ kubectl get pods,deployment -n ingress-nginx

<span style="color:#75715e"># 외부에서 nginx 인그레스 컨트롤러에 접근하기 위한 서비스도 생성됨</span>
$ kubectl get svc -n ingress-nginx
</code></pre></div><ul>
<li>ex. nginx 웹서버 인그레스 컨트롤러</li>
<li>쿠버네티스에서 공식 개발되고 있어서 컨트롤러와 관련된 모든 리소스를 한번에 설치할 수 있다.</li>
<li>설치하면 자동으로 생성되는 서비스는 LoadBalancer 타입이다.</li>
<li>실제 환경에서는 LoadBalancer 타입에 DNS 이름을 할당해 컨트롤러에 접근한다.</li>
<li>지금은 자동으로 부여된 DNS 이름(a20..2.elb.amazonaws.com)을 사용한다.<br />
<strong><em>참고로 저자는 aws 인스턴스에서 해서 저렇게 부여된 것임</em></strong><br />
<strong><em>이런 식으로 외부에서 접근 가능한 공인 IP가 필요함</em></strong></li>
<li>온프레미스 환경이면 NodePort 타입의 서비스를 생성해 사용한다.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">app.kubernetes.io/component</span>: controller
    <span style="color:#66d9ef">app.kubernetes.io/instance</span>: ingress-nginx
    <span style="color:#66d9ef">app.kubernetes.io/managed-by</span>: Helm
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: ingress-nginx
  <span style="color:#66d9ef">name</span>: ingress-nginx-controller-nodeport
  <span style="color:#66d9ef">namespace</span>: ingress-nginx
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">ports</span>:
    - <span style="color:#66d9ef">name</span>: http
      <span style="color:#66d9ef">nodePort</span>: <span style="color:#ae81ff">31000</span>
      <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">80</span>
      <span style="color:#66d9ef">protocol</span>: TCP
      <span style="color:#66d9ef">targetPort</span>: http
    - <span style="color:#66d9ef">name</span>: https
      <span style="color:#66d9ef">nodePort</span>: <span style="color:#ae81ff">32000</span>
      <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">443</span>
      <span style="color:#66d9ef">protocol</span>: TCP
      <span style="color:#66d9ef">targetPort</span>: https
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">app.kubernetes.io/component</span>: controller
    <span style="color:#66d9ef">app.kubernetes.io/instance</span>: ingress-nginx
    <span style="color:#66d9ef">app.kubernetes.io/name</span>: ingress-nginx
  <span style="color:#66d9ef">type</span>: NodePort
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl apply -f ingress-nginx-svc-nodeport.yaml
</code></pre></div></li>
</ul>
<p><br /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl apply -f hostname-deployment.yaml
$ kubectl apply -f hostname-service.yaml
</code></pre></div><ul>
<li>인그레스의 종착점이 될 테스트용 디플로이먼트와 서비스를 생성했다.</li>
<li>이제 nginx 인그레스 컨트롤러로 들어오는 요청은 이 디플로이먼트 파드들로 분산될 것이다.</li>
</ul>
<p><br /></p>
<h3 id="인그레스-컨트롤러의-동작-원리">인그레스 컨트롤러의 동작 원리</h3>
<ol>
<li>공식 깃허브에서 제공되는 YAML 파일로 nginx 인그레스 컨트롤러를 생성한다.</li>
<li>nginx 인그레스 컨트롤러를 외부로 노출하기 위한 서비스를 생성한다.</li>
<li>요청 처리 규칙을 정의하는 인그레스 오브젝트를 생성한다.</li>
<li>nginx 인그레스 컨트롤러로 들어온 요청은 인그레스 규칙에 따라 적절한 서비스로 전달된다.</li>
</ol>
<p><br /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># ENDPOINTS 항목에 출력된 지점으로 요청이 전달된다.</span>
$ kubectl get endpoints
</code></pre></div><ul>
<li>nginx 인그레스 컨트롤러는 서비스에 의해 생성된 엔드포인트로 요청을 직접 전달한다.</li>
<li>즉, 서비스의 ClusterIP가 아닌 엔드포인트의 종착 지점들로 요청이 전달된다.</li>
<li><strong>서비스를 거치지 않고 파드로 직접 요청이 전달되므로 바이패스(bypass)라고 부른다.</strong></li>
</ul>
<p><br /></p>
<h3 id="azure">Azure</h3>
<ul>
<li><code>subscription</code>
<ul>
<li>돈내는 계정</li>
<li>이 계정에 청구가 다 붙음</li>
<li>내 계정에 이 섭스크립션 계정이 여러 개 있을 수 있음</li>
</ul>
</li>
<li><code>resource group</code>
<ul>
<li>섭스크립션 계정 하나에 여러 리소스 그룹이 있을 수 있음</li>
<li>애져에서 실제로 서비스해주는 인스턴스들이 있음</li>
<li>애져 서비스들~</li>
</ul>
</li>
</ul>
<p><br /></p>
<h3 id="azure-kubernetes-tutorial">Azure kubernetes tutorial</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 그전에 띄워놨던 것들 yaml파일 기반으로 다 제거</span>
$ kubectl delete -f ./

<span style="color:#75715e"># brew 최신화</span>
$ brew update

<span style="color:#75715e"># kubectl처럼 애져명령어 치기 위한 의존 설치</span>
$ brew install azure-cli

<span style="color:#75715e"># 튜토리얼 진행</span>
$ git clone https://github.com/Azure-Samples/azure-voting-app-redis.git
$ cd azure-voting-app-redis
$ docker-compose up -d

<span style="color:#75715e"># `todorepo`는 애져에 만든 컨테이너 레지스트리명</span>
$ docker tag mcr.microsoft.com/azuredocs/azure-vote-front:v1 todorepo.azurecr.io/azure-vote-front:v1

$ az acr login --name todoRepo
$ docker push todorepo.azurecr.io/azure-vote-front:v1
$ az acr repository list --name todoRepo --output table

<span style="color:#75715e"># kubectl을 만든 쿠버네티스 클러스터를 바라보도록 연결</span>
$ az aks get-credentials --resource-group study --name todoCluster
$ kubectl apply -f azure-vote-all-in-one-redis.yaml
$ kubectl get service azure-vote-front --watch

<span style="color:#75715e"># 이후 EXTERNAL IP로 접근하면 튜토리얼 화면이 뜬다.</span>
</code></pre></div><ul>
<li><a href="https://learn.microsoft.com/en-us/azure/aks/tutorial-kubernetes-prepare-app">https://learn.microsoft.com/en-us/azure/aks/tutorial-kubernetes-prepare-app</a></li>
</ul>
<p><br /></p>
<h4 id="애져-리소스그룹-삭제한-후의-로컬에서-컨텍스트-스위칭하기">애져 리소스그룹 삭제한 후의 로컬에서 컨텍스트 스위칭하기</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl config get-contexts
$ kubectl config unset clusters.todoCluster
$ kubectl config unset contexts.todoCluster
$ kubectl config unset users.clusterUser_study_todoCluster
$ kubectl config use-context docker-desktop
$ kubectl config view

<span style="color:#75715e"># 이제 config를 보면 현재 컨텍스트가 docker-desktop이다.</span>

</code></pre></div><ul>
<li><code>Unable to connect to the server: dial tcp i/o time out~</code></li>
<li>내가 연결해놨던 애져 클러스터가 없어져서 이런 에러가 발생했다.</li>
<li>이때는 컨텍스트를 바꿔주어야 한다.</li>
<li>내 로컬 도커 데스크탑 쿠버네티스 클러스터로 바꿔주었다.</li>
</ul>
<p><br /></p>
<h4 id="쿠버네티스-yaml-파일들-있을-때-전체-삭제하기">쿠버네티스 yaml 파일들 있을 때 전체 삭제하기</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">~ kubectl delete -f ./

deployment.apps <span style="color:#e6db74">&#34;hostname-deployment&#34;</span> deleted
service <span style="color:#e6db74">&#34;hostname-service&#34;</span> deleted
ingress.networking.k8s.io <span style="color:#e6db74">&#34;ingress-example&#34;</span> deleted
deployment.apps <span style="color:#e6db74">&#34;todo-deployment&#34;</span> deleted
Error from server <span style="color:#f92672">(</span>NotFound<span style="color:#f92672">)</span>: error when deleting <span style="color:#e6db74">&#34;ingress-nginx-svc-nodeport.yaml&#34;</span>: services <span style="color:#e6db74">&#34;ingress-nginx-controller-nodeport&#34;</span> not found
Error from server <span style="color:#f92672">(</span>NotFound<span style="color:#f92672">)</span>: error when deleting <span style="color:#e6db74">&#34;todo-pod.yaml&#34;</span>: pods <span style="color:#e6db74">&#34;todo-pod&#34;</span> not found
Error from server <span style="color:#f92672">(</span>NotFound<span style="color:#f92672">)</span>: error when deleting <span style="color:#e6db74">&#34;todo-replicaset.yaml&#34;</span>: replicasets.apps <span style="color:#e6db74">&#34;todo-replicaset&#34;</span> not found
unable to decode <span style="color:#e6db74">&#34;.angular-config.json&#34;</span>: Object <span style="color:#e6db74">&#39;Kind&#39;</span> is missing in <span style="color:#e6db74">&#39;{
</span><span style="color:#e6db74">  &#34;version&#34;: 1,
</span><span style="color:#e6db74">  &#34;cli&#34;: {
</span><span style="color:#e6db74">    &#34;analytics&#34;: false
</span><span style="color:#e6db74">  }
</span><span style="color:#e6db74">}&#39;</span>
</code></pre></div><ul>
<li><code>Cannot ls ~/.Trash in the Terminal~</code></li>
<li>위 메시지와 함께 권한 문제가 발생한다면?</li>
<li>이때는 터미널에 <code>설정 &gt; 개인 정보 보호 &gt; 전체 디스크 접근 권한</code>을 주고 실행하자.</li>
</ul>
</div>

</main>

        <footer>
            <p class="copyright text-muted">© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

