---
title: "모두를 위한 클라우드 컴퓨팅 7"
date: "2022-11-15"
tags: ["cloud-computing"]
draft: false
---

## 도커와 젠킨스를 이용한 CI/CD 파이프라인 구성

### CI (Continuous Integration)

- 개발자가 작성한 코드가 특정 시간이 아닌 지속적으로 배포되어야 할 통합본에 통합되는 것
- 이를 통해 언제든지 필요에 따라 수정된 코드가 반영되고 통합되어 자동으로 배포될 수 있음

<br />

### CD (Continuous Deployment)

- CI 단계에서 통합된 소스를 repo로 자동 릴리즈 하는 단계를 의미함
- 준비된 빌드를 사람의 개입 없이 자동으로 릴리즈 함

<br />

### 실습: 서버 생성하고 도커/젠킨스 설정

- AWS Lightsail (EC2보다 저렴하고 설정이 간단) 생성
  - 플랫폼은 Linux, 블루프린트는 OS Only, CentOS 7
  - SSH 키 페어는 기본키를 선택
  - 메모리 1GB 선택
- 둘다 인스턴스 터미널에 접속해 도커 설치

  ```
  $ curl -fsSl https://get.docker.com -o get-docker.sh

  // 슈퍼유저 권한으로 실행
  $ sudo sh get-docker.sh

  // 현재 계정을 docker 그룹에 추가
  // centos 접속 상태로 docker 명령어를 sudo 없이 수행 가능해짐
  // 참고로 현재 터미널 세션에는 적용되지 않으므로 껐켰 ㄱㄱ
  $ sudo usermod -aG docker centos

  // 도커 실행 및 인스턴스 재부팅되어도 자동 실행되도록 함
  $ sudo systemctl start docker
  $ sudo systemctl enable docker

  $ docker ps
  ```

- 젠킨스도 설치

  ```
  // 권한 문제가 뜨면 소유권을 centos로 변경해야 함
  $ docker run -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/jenkins/home:/var/jenkins_home \
  -p 8080:8080 --name jenkins jenkins/jenkins

  $ ls -l /srv/jenkins
  total 0
  drwxr-xr-x. 2 root root 6 Nov 15 11:06 home

  $ sudo chown -R centos:centos /srv/jenkins/home/
  total 0
  drwxr-xr-x. 2 centos centos 6 Nov 15 11:06 home

  // 종료상태인 젠킨스 컨테이너 제거 후 다시 실행
  // 젠킨스 최초 접속 시 필요한 패스워드니까 기록해두기
  $ docker rm jenkins
  $ docker run -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/jenkins/home:/var/jenkins_home \
  -p 8080:8080 --name jenkins jenkins/jenkins

  *************************************************************
  Jenkins initial setup is required. An admin user has been created and a password generated.
  Please use the following password to proceed to installation:

  {password}

  This may also be found at: /var/jenkins_home/secrets/initialAdminPassword
  *************************************************************

  // 백그라운드로 실행하는 d 옵션을 추가해 젠킨스 컨테이너 실행
  $ docker rm jenkins
  $ docker run -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/jenkins/home:/var/jenkins_home \
  -p 8080:8080 -d --name jenkins jenkins/jenkins
  ```

- 콘솔에서 centOS > manage > networing 이동
  - IPv4 Firewall에 8080 포트를 추가
  - public IP 주소를 복사해 :8080 포트 붙여서 웹브라우저로 접속
- 컨테이너 내부에서 도커 명령어 사용할 수 있게 설정

  ```
  $ cat /etc/group | grep docker
  docker:x:994:centos

  // 도커 컨테이너 루트로 접속함
  // -u 0 옵션은 사용자를 루트로 접속시키라는 의미
  $ docker exec -it -u 0 jenkins bash
  root@~~~:/#

  // 이때 도커 바이너리는 본인에게 설치된 버전 링크로 복붙
  root@~~~:/# curl -fsSl https://download.docker.com/linux/static/stable/x86_64/dock
  er-20.10.21.tgz -o docker-20.10.21.tgz
  root@~~~:/# ls -l docker-20.10.21.tgz
  -rw-r--r--. 1 root root 65976998 Nov 15 11:36 docker-20.10.21.tgz

  // 다운로드한 바이너리 파일 압축해제
  root@~~~:/# tar xvfz docker-20.10.21.tgz
  root@~~~:/# cp ./docker/docker /usr/bin
  root@~~~:/# ls -l /usr/bin/docker
  -rwxr-xr-x. 1 root root 48047088 Nov 15 11:38 /usr/bin/docker

  // 젠킨스 컨테이너 내부에 docker 그룹 추가
  // centOS-1의 docker 그룹과 동일한 ID(994) 추가
  root@~~~:/# groupadd -g 994 docker
  root@~~~:/# cat /etc/group | grep docker

  // 젠킨스 컨테이너 내부에 jenkins 계정 추가
  root@~~~:/# usermod -aG docker jenkins
  root@~~~:/# id jenkins
  uid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins),994(docker)

  root@~~~:/# exit

  // 젠킨스 계정으로 젠킨스 컨테이너에 접속
  // 본인 도커허브 로그인할 때 이메일 말고 ID 써야함
  $ docker exec -it jenkins bash
  $ docker ps
  $ docker login
  ...
  Login Succeeded
  $ exit
  $ docker restart jenkins
  ```

<br />

### 실습: github와 젠킨스 연동 설정

- 어쩌구저쩌구 깃헙 repo 하나 생성
- Settings > Webhooks > add webhook
  - `http://{centOS-1 IP주소}:8080/github-webhook`
- 이제 해당 repo에 푸시 이벤트가 발생하면 젠킨스로 웹훅이 전송된다.
- develop 브랜치로 해당 동작을 수행하기 위해 젠킨스에 추가한다.
  - 새로운 Item > Freestyle project
  - 소스코드 관리 >
    - git 체크
    - repo URL 입력 (https://github.com/wacilpong/jenkins)
    - branches to build 입력 (`*/develop`)
  - 빌드유발 > github hook trigger 체크
  - Build > add build step > execute shell 추가
    - `docker build -t nginx:test . && sh container_check.sh`
    - 로컬에 있는 Dockerfile 이용해 nginx 이미지 생성, 이미지에 test라는 태그를 부여한다.
    - 이후에 container_check.sh 스크립트를 수행한다.
  - 빌드 후 조치 > Delete workspace when build is done

<br />

### 실습: nginx 예제 프로젝트 가져와 develop 브랜치에 푸시하기

```
$ wget https://github.com/startbootstrap/startbootstrap-freelancer/archive/gh-pages.zip
$ unzip gh-pages.zip
$ cp -r startbootstrap-freelancer-gh-pages/* ./
$ rm -rf gh-pages.zip startbootstrap-freelancer-gh-pages/
$ vi Dockerfile
FROM nginx:latest
COPY . /usr/share/nginx/html

$ vi container_check.sh
NGINX_CONTAINER_ID=`docker ps -aq --filter 'name=nginx'`

if [ -n "$NGINX_CONTAINER_ID" ];
  then
      echo "nginx container exist"
      docker stop $NGINX_CONTAINER_ID
      docker rm $NGINX_CONTAINER_ID
      docker run -d -p 80:80 --name nginx nginx:test
  else
      echo "nginx container not exist"
      docker run -d -p 80:80 --name nginx nginx:test
fi

$ ga .
$ g commit -m "ADD test files"
$ gp -u origin develop
```

- 이후 본인 centOS-1 public IP 접속하면 화면이 보일 것이다. (80이므로 포트 생략가능)
